# Init Command Updates

## Summary

The `fare init` command has been updated to automatically generate a Solana keypair for the **heartbeat service** during casino initialization. This eliminates the need to manually generate and configure the `HEARTBEAT_PRIVATE_KEY`.

## What Changed

### 1. Automatic Keypair Generation
When you run `fare init <casino-name>`, the CLI now:
- ✅ Auto-generates a Solana keypair for the heartbeat service
- ✅ Displays the public key in the configuration summary
- ✅ Stores the private key securely in the `.env` file
- ✅ Sets the private key as a Fly.io secret for production

### 2. Environment Variables Added
The generated `.env` file now includes:
```env
# Solana Configuration
SOLANA_OWNER_ADDRESS=<your-owner-wallet>  # Casino manager address
HEARTBEAT_PRIVATE_KEY=<auto-generated>     # For discovery service

# Both are also set in Fly.io secrets automatically
```

### 3. Configuration Summary Enhanced
During initialization, you'll now see:
```
Summary:
──────────────────────────────────────────────────
Casino Name:      my-casino
Owner Wallet:     7xK...abc
Heartbeat Key:    5Hj...xyz  ← NEW: Auto-generated
Solana RPC:       https://api.mainnet-beta.solana.com
JWT Secret:       ********...
──────────────────────────────────────────────────
```

## Benefits

### Before (Manual Process)
1. Run `fare init <casino-name>`
2. Deployment completes
3. Realize heartbeat service isn't configured
4. Run `fare keygen --label heartbeat --output env`
5. Copy key to production: `fly secrets set HEARTBEAT_PRIVATE_KEY=...`
6. Restart the app

### After (Automated)
1. Run `fare init <casino-name>`
2. ✅ Everything is configured automatically
3. ✅ Heartbeat service works immediately on first deploy

## Technical Details

### What is the Heartbeat Service?
The heartbeat service pings the Fareplay Discovery Service every 15 minutes to:
- Register your casino in the network
- Report casino status (online/offline/maintenance)
- Share metrics (active players, total bets, uptime)
- Make your casino discoverable to players

### Keypair Purpose
- **Private Key**: Signs heartbeat requests to prove authenticity
- **Public Key**: Identifies your casino in the discovery service
- **Security**: Keys are auto-generated per casino, stored securely

### Where Keys Are Stored

#### Local Development
```
/casinos/<your-casino>/.env
```
The `.env` file is git-ignored for security.

#### Production (Fly.io)
```bash
fly secrets list -a fare-<your-casino>
```
Keys are stored as encrypted secrets, never in plain text.

## Manual Keygen Still Available

If you need to generate additional keypairs or regenerate keys:

```bash
# Generate a new heartbeat key
fare keygen --label heartbeat --output env

# Then update your production secrets
fly secrets set HEARTBEAT_PRIVATE_KEY=<new-key> -a fare-<your-casino>
```

## Troubleshooting

### "Non-base58 character" Error
If you see this error in your backend logs:
```
Error: Failed to sign message: Non-base58 character
```

**Solution**: Your `HEARTBEAT_PRIVATE_KEY` is malformed. Generate a new one:
```bash
fare keygen --label heartbeat --output env
```

Then update your production secret:
```bash
fly secrets set HEARTBEAT_PRIVATE_KEY=<new-key> -a fare-<your-casino>
```

### Verify Heartbeat Service
Check if heartbeats are working:

1. **Check logs**:
   ```bash
   fare logs api
   ```
   
   Look for:
   ```
   [HeartbeatService] Heartbeat service initialized
   [HeartbeatService] ✅ Heartbeat sent - Status: online
   ```

2. **Check discovery service** (coming soon):
   ```bash
   fare status --discovery
   ```

### Regenerate Keys
If you need to regenerate your heartbeat key:

```bash
# 1. Generate new key
fare keygen --label heartbeat --output env

# 2. Update local .env (for development)
# Copy output to casinos/<your-casino>/.env

# 3. Update Fly.io secrets (for production)
fly secrets set HEARTBEAT_PRIVATE_KEY=<new-key> -a fare-<your-casino>

# 4. Restart your casino
fly apps restart fare-<your-casino>
```

## Migration Guide

If you have an existing casino without a heartbeat key:

### Option 1: Use fare keygen (Quick)
```bash
# Generate the key
fare keygen --label heartbeat --output env

# Update production
fly secrets set HEARTBEAT_PRIVATE_KEY=<generated-key> -a fare-<your-casino>
fly secrets set SOLANA_OWNER_ADDRESS=<your-owner-wallet> -a fare-<your-casino>

# Restart
fly apps restart fare-<your-casino>
```

### Option 2: Redeploy (Complete)
```bash
# This will regenerate all keys and redeploy
cd casinos/<your-casino>
fare deploy
```

## Security Best Practices

🔒 **Never commit `.env` files to git**
- The CLI automatically adds `.env` to `.gitignore`
- Double-check before pushing any code

🔒 **Different keys per environment**
- Development: Use keys from local `.env`
- Production: Use Fly.io secrets (automatically set during init)

🔒 **Owner vs Heartbeat Keys**
- **Owner Wallet**: Your main casino manager wallet (use existing wallet)
- **Heartbeat Key**: Auto-generated service key (unique per casino)

## Future Enhancements

Coming soon:
- [ ] Automatic key rotation
- [ ] Multi-environment key management
- [ ] Key backup and recovery tools
- [ ] Discovery service health dashboard

## Related Commands

- `fare keygen` - Generate additional Solana keypairs
- `fare deploy` - Redeploy with updated configuration
- `fare status` - Check casino and service status
- `fare logs api` - View backend logs including heartbeat

## Questions?

- Heartbeat service docs: (coming soon)
- Discovery service API: (coming soon)
- Solana keypairs: https://docs.solana.com/cli/usage#keypair-management

